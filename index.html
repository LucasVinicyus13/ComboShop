<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ComboShop | Registrar</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <h1>Registrar–se</h1>

    <form id="registerForm" method="POST">
      <label for="fullname">Nome Completo:</label>
      <input type="text" id="fullname" name="fullname" placeholder="Nome Completo" required />

      <label for="username">Nome de Usuário:</label>
      <input type="text" id="username" name="username" placeholder="Nome de Usuário" required />

      <label for="email">E-mail:</label>
      <input type="email" id="email" name="email" placeholder="seuemail@exemplo.com" required />

      <label for="cpf">CPF:</label>
      <input type="text" id="cpf" name="cpf" placeholder="000.000.000-00" maxlength="14" required />

      <label for="password">Senha:</label>
      <input type="password" id="password" name="password" placeholder="Senha" required />

      <button type="submit" id="registerBtn">Registrar-se</button>
    </form>

    <p>Já tem uma conta? <a href="/login/login.html">Entrar</a></p>
  </div>

  <!-- ========== SCRIPT ========== -->
  <script type="module">
    // === Firebase Configuração ===
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      query,
      where,
      getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
    import {
      getAuth,
      createUserWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyACfEok2lIudcax8QwH6VFaJ4OeYdcLQ4E",
      authDomain: "comboshop-7a3dc.firebaseapp.com",
      projectId: "comboshop-7a3dc",
      storageBucket: "comboshop-7a3dc.appspot.com",
      messagingSenderId: "781234987276",
      appId: "1:781234987276:web:7b4127df8a712a6bcd6f41"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // === Máscara CPF ===
    const cpfInput = document.getElementById("cpf");
    cpfInput.addEventListener("input", (e) => {
      let v = e.target.value.replace(/\D/g, "");
      if (v.length > 11) v = v.slice(0, 11);
      e.target.value = v
        .replace(/(\d{3})(\d)/, "$1.$2")
        .replace(/(\d{3})(\d)/, "$1.$2")
        .replace(/(\d{3})(\d{1,2})$/, "$1-$2");
    });

    // === Registro de Usuário ===
    const registerForm = document.getElementById("registerForm");

    registerForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const fullname = document.getElementById("fullname").value.trim();
      const username = document.getElementById("username").value.trim();
      const email = document.getElementById("email").value.trim();
      const cpf = document.getElementById("cpf").value.trim();
      const password = document.getElementById("password").value;

      if (!fullname || !username || !email || !cpf || !password) {
        alert("Preencha todos os campos!");
        return;
      }

      try {
        // Verifica se já existe CPF ou usuário
        const usersRef = collection(db, "users");
        const [cpfSnap, userSnap] = await Promise.all([
          getDocs(query(usersRef, where("cpf", "==", cpf))),
          getDocs(query(usersRef, where("username", "==", username))),
        ]);

        if (!cpfSnap.empty || !userSnap.empty) {
          const popup = document.createElement("div");
          popup.innerHTML = `
            <div style="
              position: fixed; inset: 0; background: rgba(0,0,0,0.6);
              display: flex; align-items: center; justify-content: center; z-index: 9999;
            ">
              <div style="
                background: linear-gradient(135deg, #4B0082, #8A2BE2);
                color: white; padding: 25px; border-radius: 20px; text-align: center;
                box-shadow: 0 0 15px rgba(0,0,0,0.4);
              ">
                <p>Já existe um usuário com esse nome de usuário ou CPF.</p>
                <p>É você? <a href="/login/login.html" style="color:#00ffff;text-decoration:underline;">Fazer login</a></p>
              </div>
            </div>`;
          document.body.appendChild(popup);
          return;
        }

        // Cria usuário no Auth
        const cred = await createUserWithEmailAndPassword(auth, email, password);

        // Salva no Firestore
        await addDoc(usersRef, {
          uid: cred.user.uid,
          fullname,
          username,
          email,
          cpf,
        });

        alert("Conta criada com sucesso!");
        window.location.href = "https://combo-shop.vercel.app/products/produtos.html";

      } catch (err) {
        console.error(err);
        alert("Erro ao registrar: " + err.message);
      }
    });
  </script>
</body>
</html>
